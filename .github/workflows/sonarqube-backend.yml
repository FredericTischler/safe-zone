name: SonarCloud Backend Analysis

# ============================================================================
# TRIGGERS
# ============================================================================
# Execute workflow on push or pull request to main branch
# Only run when backend files are modified
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/sonarqube-backend.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/sonarqube-backend.yml'

# ============================================================================
# PERMISSIONS
# ============================================================================
# Required for PR comments and SonarCloud integration
permissions:
  contents: read
  pull-requests: write
  checks: write

# ============================================================================
# JOBS
# ============================================================================
jobs:
  # --------------------------------------------------------------------------
  # Backend Analysis with Matrix Strategy
  # Runs SonarCloud analysis for all 3 microservices in parallel
  # --------------------------------------------------------------------------
  backend-analysis:
    name: Analyze ${{ matrix.service }}
    runs-on: ubuntu-latest

    # Matrix strategy to run all 3 services in parallel
    strategy:
      # Continue running other services even if one fails
      fail-fast: false
      matrix:
        service:
          - user-service
          - product-service
          - media-service
        include:
          - service: user-service
            project-key: ecommerce-user-service
            display-name: User Service
          - service: product-service
            project-key: ecommerce-product-service
            display-name: Product Service
          - service: media-service
            project-key: ecommerce-media-service
            display-name: Media Service

    steps:
      # ----------------------------------------------------------------------
      # Step 1: Checkout Code
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        # v4
        with:
          # Full clone for SonarCloud to access complete history
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # Step 2: Setup Java 17
      # ----------------------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9
        # v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ----------------------------------------------------------------------
      # Step 3: Cache SonarCloud Packages
      # Caching speeds up subsequent builds
      # ----------------------------------------------------------------------
      - name: Cache SonarCloud packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ matrix.service }}
          restore-keys: |
            ${{ runner.os }}-sonar-${{ matrix.service }}
            ${{ runner.os }}-sonar

      # ----------------------------------------------------------------------
      # Step 4: Cache Maven Dependencies
      # Speeds up builds by caching downloaded dependencies
      # ----------------------------------------------------------------------
      - name: Cache Maven packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ matrix.service }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-${{ matrix.service }}
            ${{ runner.os }}-maven

      # ----------------------------------------------------------------------
      # Step 5: Build and Run Tests with Coverage
      # JaCoCo generates coverage reports for SonarCloud
      # ----------------------------------------------------------------------
      - name: Build and test with Maven
        working-directory: backend/${{ matrix.service }}
        run: |
          echo "Building and testing ${{ matrix.display-name }}..."
          mvn clean verify -B \
            -DskipTests=false \
            -Dmaven.test.failure.ignore=false
        continue-on-error: false

      # ----------------------------------------------------------------------
      # Step 6: Run SonarCloud Analysis
      # Sends code and coverage data to SonarCloud
      # ----------------------------------------------------------------------
      - name: SonarCloud Scan
        working-directory: backend/${{ matrix.service }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running SonarCloud analysis for ${{ matrix.display-name }}..."
          mvn sonar:sonar -B \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=zone01-ecommerce \
            -Dsonar.projectKey=${{ matrix.project-key }} \
            -Dsonar.projectName="${{ matrix.display-name }}" \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.exclusions=**/config/**,**/dto/**,**/entity/**,**/*Application.java \
            -Dsonar.coverage.exclusions=**/config/**,**/dto/**,**/entity/**,**/*Application.java

      # ----------------------------------------------------------------------
      # Step 7: Wait for Quality Gate
      # Checks if code meets quality standards
      # ----------------------------------------------------------------------
      - name: SonarCloud Quality Gate check
        uses: SonarSource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b
        # v1.2.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: backend/${{ matrix.service }}/target/sonar/report-task.txt
        continue-on-error: true
        id: quality-gate

      # ----------------------------------------------------------------------
      # Step 8: Upload Coverage Reports as Artifacts
      # Preserves reports for later inspection
      # ----------------------------------------------------------------------
      - name: Upload coverage reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        # v4
        if: always()
        with:
          name: coverage-${{ matrix.service }}
          path: |
            backend/${{ matrix.service }}/target/site/jacoco/
            backend/${{ matrix.service }}/target/surefire-reports/
          retention-days: 30

      # ----------------------------------------------------------------------
      # Step 9: Comment PR with Results
      # Posts analysis results directly to PR
      # ----------------------------------------------------------------------
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const service = '${{ matrix.display-name }}';
            const projectKey = '${{ matrix.project-key }}';
            const qualityGateStatus = '${{ steps.quality-gate.outputs.quality-gate-status }}' || 'UNKNOWN';
            const statusEmoji = qualityGateStatus === 'PASSED' ? '‚úÖ' : qualityGateStatus === 'FAILED' ? '‚ùå' : '‚ö†Ô∏è';

            const body = `## ${statusEmoji} SonarCloud Analysis - ${service}

            **Quality Gate:** ${statusEmoji} \`${qualityGateStatus}\`

            **Details:**
            - üîç [View Full Analysis](https://sonarcloud.io/project/overview?id=${projectKey})
            - üìä Project Key: \`${projectKey}\`
            - üèóÔ∏è Build: [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ${qualityGateStatus === 'FAILED' ? '‚ö†Ô∏è **Action Required:** Please fix the issues identified by SonarCloud before merging.' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # ----------------------------------------------------------------------
      # Step 10: Fail Job if Quality Gate Failed
      # Ensures CI fails when quality standards are not met
      # ----------------------------------------------------------------------
      - name: Fail if Quality Gate failed
        if: steps.quality-gate.outputs.quality-gate-status == 'FAILED'
        run: |
          echo "‚ùå Quality Gate failed for ${{ matrix.display-name }}"
          echo "Please review the issues at: https://sonarcloud.io/project/overview?id=${{ matrix.project-key }}"
          exit 1
