name: SonarCloud Full Analysis

# ============================================================================
# TRIGGERS
# ============================================================================
# Execute workflow on push or pull request to main branch
# Runs for all changes across the entire project
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# ============================================================================
# PERMISSIONS
# ============================================================================
# Required for PR comments and SonarCloud integration
permissions:
  contents: read
  pull-requests: write
  checks: write

# ============================================================================
# JOBS
# ============================================================================
jobs:
  # --------------------------------------------------------------------------
  # Job 1: Backend Analysis with Matrix Strategy
  # Runs SonarCloud analysis for all 3 microservices in parallel
  # --------------------------------------------------------------------------
  backend-analysis:
    name: Backend - ${{ matrix.service }}
    runs-on: ubuntu-latest

    # Matrix strategy to run all 3 services in parallel
    strategy:
      fail-fast: false
      matrix:
        service:
          - user-service
          - product-service
          - media-service
        include:
          - service: user-service
            project-key: ecommerce-user-service
            display-name: User Service
          - service: product-service
            project-key: ecommerce-product-service
            display-name: Product Service
          - service: media-service
            project-key: ecommerce-media-service
            display-name: Media Service

    outputs:
      user-service-status: ${{ steps.set-status.outputs.user-service-status }}
      product-service-status: ${{ steps.set-status.outputs.product-service-status }}
      media-service-status: ${{ steps.set-status.outputs.media-service-status }}

    steps:
      # ----------------------------------------------------------------------
      # Checkout Code
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        # v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # Setup Java 17
      # ----------------------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9
        # v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ----------------------------------------------------------------------
      # Cache SonarCloud and Maven
      # ----------------------------------------------------------------------
      - name: Cache SonarCloud packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ matrix.service }}
          restore-keys: |
            ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven

      # ----------------------------------------------------------------------
      # Build and Test
      # ----------------------------------------------------------------------
      - name: Build and test with Maven
        working-directory: backend/${{ matrix.service }}
        run: |
          echo "üî® Building and testing ${{ matrix.display-name }}..."
          mvn clean verify -B -DskipTests=false
        continue-on-error: false

      # ----------------------------------------------------------------------
      # SonarCloud Analysis
      # ----------------------------------------------------------------------
      - name: SonarCloud Scan
        working-directory: backend/${{ matrix.service }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Running SonarCloud analysis for ${{ matrix.display-name }}..."
          mvn sonar:sonar -B \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=zone01-ecommerce \
            -Dsonar.projectKey=${{ matrix.project-key }} \
            -Dsonar.projectName="${{ matrix.display-name }}" \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      # ----------------------------------------------------------------------
      # Quality Gate Check
      # ----------------------------------------------------------------------
      - name: SonarCloud Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@v3.0.0  # Pinned to specific version for security
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: backend/${{ matrix.service }}/target/sonar/report-task.txt
        continue-on-error: true
        id: quality-gate

      # ----------------------------------------------------------------------
      # Upload Artifacts
      # ----------------------------------------------------------------------
      - name: Upload coverage reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        # v4
        if: always()
        with:
          name: coverage-backend-${{ matrix.service }}
          path: backend/${{ matrix.service }}/target/site/jacoco/
          retention-days: 30

      # ----------------------------------------------------------------------
      # Set Status Output
      # ----------------------------------------------------------------------
      - name: Set status output
        id: set-status
        if: always()
        run: |
          STATUS="${{ steps.quality-gate.outputs.quality-gate-status }}"
          echo "${{ matrix.service }}-status=${STATUS:-UNKNOWN}" >> $GITHUB_OUTPUT

  # --------------------------------------------------------------------------
  # Job 2: Frontend Analysis
  # Runs SonarCloud analysis for Angular frontend
  # --------------------------------------------------------------------------
  frontend-analysis:
    name: Frontend (Angular)
    runs-on: ubuntu-latest

    outputs:
      frontend-status: ${{ steps.quality-gate.outputs.quality-gate-status }}

    steps:
      # ----------------------------------------------------------------------
      # Checkout Code
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        # v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # Setup Node.js 20
      # ----------------------------------------------------------------------
      - name: Set up Node.js 20
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # ----------------------------------------------------------------------
      # Cache Dependencies
      # ----------------------------------------------------------------------
      - name: Cache node modules
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4
        with:
          path: |
            frontend/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache SonarCloud packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-frontend
          restore-keys: |
            ${{ runner.os }}-sonar

      # ----------------------------------------------------------------------
      # Install, Test, and Build
      # ----------------------------------------------------------------------
      - name: Install dependencies
        working-directory: frontend
        run: |
          echo "üì¶ Installing npm dependencies..."
          npm ci --prefer-offline --no-audit

      - name: Run tests with coverage
        working-directory: frontend
        run: |
          echo "üß™ Running tests with coverage..."
          npm run test -- --no-watch --no-progress --browsers=ChromeHeadless --code-coverage
        env:
          CHROME_BIN: /usr/bin/google-chrome-stable

      - name: Build application
        working-directory: frontend
        run: |
          echo "üèóÔ∏è Building Angular application..."
          npm run build -- --configuration production

      # ----------------------------------------------------------------------
      # SonarCloud Analysis
      # ----------------------------------------------------------------------
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@e44258b109568baa0df60ed515909fc6c72cba92
        # v2.3.0 - Pinned to specific version for security
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectBaseDir: frontend
          args: >
            -Dsonar.organization=zone01-ecommerce
            -Dsonar.projectKey=ecommerce-frontend
            -Dsonar.projectName=E-Commerce Frontend
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts
            -Dsonar.exclusions=**/*.spec.ts,**/node_modules/**,**/dist/**,**/coverage/**
            -Dsonar.javascript.lcov.reportPaths=coverage/frontend/lcov.info

      # ----------------------------------------------------------------------
      # Quality Gate Check
      # ----------------------------------------------------------------------
      - name: SonarCloud Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@v3.0.0  # Pinned to specific version for security
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true
        id: quality-gate

      # ----------------------------------------------------------------------
      # Upload Artifacts
      # ----------------------------------------------------------------------
      - name: Upload coverage reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        # v4
        if: always()
        with:
          name: coverage-frontend
          path: frontend/coverage/
          retention-days: 30

  # --------------------------------------------------------------------------
  # Job 3: Summary and Overall Status
  # Aggregates results from all services and posts comprehensive PR comment
  # --------------------------------------------------------------------------
  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [backend-analysis, frontend-analysis]
    if: always()

    steps:
      # ----------------------------------------------------------------------
      # Checkout for PR comments
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        # v4

      # ----------------------------------------------------------------------
      # Determine Overall Status
      # ----------------------------------------------------------------------
      - name: Determine overall status
        id: overall-status
        run: |
          # Get individual statuses
          USER_STATUS="${{ needs.backend-analysis.outputs.user-service-status }}"
          PRODUCT_STATUS="${{ needs.backend-analysis.outputs.product-service-status }}"
          MEDIA_STATUS="${{ needs.backend-analysis.outputs.media-service-status }}"
          FRONTEND_STATUS="${{ needs.frontend-analysis.outputs.frontend-status }}"

          echo "User Service: ${USER_STATUS:-UNKNOWN}"
          echo "Product Service: ${PRODUCT_STATUS:-UNKNOWN}"
          echo "Media Service: ${MEDIA_STATUS:-UNKNOWN}"
          echo "Frontend: ${FRONTEND_STATUS:-UNKNOWN}"

          # Check if any failed
          if [[ "${USER_STATUS}" == "FAILED" ]] || \
             [[ "${PRODUCT_STATUS}" == "FAILED" ]] || \
             [[ "${MEDIA_STATUS}" == "FAILED" ]] || \
             [[ "${FRONTEND_STATUS}" == "FAILED" ]]; then
            echo "overall-status=FAILED" >> $GITHUB_OUTPUT
            echo "Overall status: FAILED"
          elif [[ "${USER_STATUS}" == "PASSED" ]] && \
               [[ "${PRODUCT_STATUS}" == "PASSED" ]] && \
               [[ "${MEDIA_STATUS}" == "PASSED" ]] && \
               [[ "${FRONTEND_STATUS}" == "PASSED" ]]; then
            echo "overall-status=PASSED" >> $GITHUB_OUTPUT
            echo "Overall status: PASSED"
          else
            echo "overall-status=UNKNOWN" >> $GITHUB_OUTPUT
            echo "Overall status: UNKNOWN"
          fi

      # ----------------------------------------------------------------------
      # Post Comprehensive PR Comment
      # ----------------------------------------------------------------------
      - name: Comment PR with comprehensive summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get all statuses
            const userStatus = '${{ needs.backend-analysis.outputs.user-service-status }}' || 'UNKNOWN';
            const productStatus = '${{ needs.backend-analysis.outputs.product-service-status }}' || 'UNKNOWN';
            const mediaStatus = '${{ needs.backend-analysis.outputs.media-service-status }}' || 'UNKNOWN';
            const frontendStatus = '${{ needs.frontend-analysis.outputs.frontend-status }}' || 'UNKNOWN';
            const overallStatus = '${{ steps.overall-status.outputs.overall-status }}';

            // Helper function to get emoji
            const getEmoji = (status) => {
              if (status === 'PASSED') return '‚úÖ';
              if (status === 'FAILED') return '‚ùå';
              return '‚ö†Ô∏è';
            };

            // Build comprehensive summary table
            const body = `# üîç SonarCloud Full Analysis Summary

            ## Overall Status: ${getEmoji(overallStatus)} \`${overallStatus}\`

            ---

            ## üìä Analysis Results

            | Component | Status | Quality Gate | Details |
            |-----------|--------|--------------|---------|
            | **User Service** | ${getEmoji(userStatus)} | \`${userStatus}\` | [View Analysis](https://sonarcloud.io/project/overview?id=ecommerce-user-service) |
            | **Product Service** | ${getEmoji(productStatus)} | \`${productStatus}\` | [View Analysis](https://sonarcloud.io/project/overview?id=ecommerce-product-service) |
            | **Media Service** | ${getEmoji(mediaStatus)} | \`${mediaStatus}\` | [View Analysis](https://sonarcloud.io/project/overview?id=ecommerce-media-service) |
            | **Frontend (Angular)** | ${getEmoji(frontendStatus)} | \`${frontendStatus}\` | [View Analysis](https://sonarcloud.io/project/overview?id=ecommerce-frontend) |

            ---

            ## üîó Quick Links

            - üè¢ **Organization:** [zone01-ecommerce](https://sonarcloud.io/organizations/zone01-ecommerce)
            - üèóÔ∏è **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - üì¶ **Branch:** \`${{ github.head_ref || github.ref_name }}\`
            - üíæ **Commit:** \`${{ github.sha }}\`.substring(0, 7)

            ---

            ${overallStatus === 'FAILED' ? `## ‚ö†Ô∏è Action Required

            One or more quality gates have failed. Please review and fix the issues identified by SonarCloud before merging this PR.

            **Next Steps:**
            1. Click on the "View Analysis" links above to see detailed issues
            2. Fix the identified code quality, security, or coverage issues
            3. Push your changes to trigger a new analysis
            ` : `## ‚úÖ All Quality Gates Passed

            Great work! All components have passed their quality gates. This PR is ready for review.
            `}

            ---

            <sub>Generated by [SonarCloud Full Analysis Workflow](https://github.com/${{ github.repository }}/actions/workflows/sonarqube-full.yml)</sub>
            `;

            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('SonarCloud Full Analysis Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ----------------------------------------------------------------------
      # Fail if Overall Status is FAILED
      # ----------------------------------------------------------------------
      - name: Fail if quality gates failed
        if: steps.overall-status.outputs.overall-status == 'FAILED'
        run: |
          echo "‚ùå One or more quality gates have failed"
          echo "Please review the SonarCloud results and fix the issues"
          exit 1

      # ----------------------------------------------------------------------
      # Success Message
      # ----------------------------------------------------------------------
      - name: Success message
        if: steps.overall-status.outputs.overall-status == 'PASSED'
        run: |
          echo "‚úÖ All quality gates passed successfully!"
          echo "üéâ Great work! The code meets all quality standards."