<h2 mat-dialog-title>
  {{ data.mode === 'edit' ? 'Modifier le produit' : 'Nouveau produit' }}
</h2>

<mat-dialog-content>
  <form [formGroup]="productForm">
    <!-- Name Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Nom du produit</mat-label>
      <input matInput formControlName="name" placeholder="Ex: iPhone 15 Pro">
      @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
        <mat-error>{{ getErrorMessage('name') }}</mat-error>
      }
    </mat-form-field>

    <!-- Description Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Description</mat-label>
      <textarea 
        matInput 
        formControlName="description" 
        rows="4"
        placeholder="Décrivez votre produit..."></textarea>
      @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
        <mat-error>{{ getErrorMessage('description') }}</mat-error>
      }
    </mat-form-field>

    <!-- Price and Stock Row -->
    <div class="form-row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Prix (€)</mat-label>
        <input matInput type="number" formControlName="price" step="0.01" placeholder="1299.99">
        <span matTextPrefix>€&nbsp;</span>
        @if (productForm.get('price')?.invalid && productForm.get('price')?.touched) {
          <mat-error>{{ getErrorMessage('price') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Stock</mat-label>
        <input matInput type="number" formControlName="stock" placeholder="50">
        @if (productForm.get('stock')?.invalid && productForm.get('stock')?.touched) {
          <mat-error>{{ getErrorMessage('stock') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Category Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Catégorie</mat-label>
      <mat-select formControlName="category">
        @for (category of categories; track category) {
          <mat-option [value]="category">{{ category }}</mat-option>
        }
      </mat-select>
      @if (productForm.get('category')?.invalid && productForm.get('category')?.touched) {
        <mat-error>{{ getErrorMessage('category') }}</mat-error>
      }
    </mat-form-field>

    <!-- Image Upload Section -->
    <div class="image-upload-section">
      <label class="upload-label" for="product-images-input">Images du produit</label>
      
      <!-- Existing Images (in edit mode) -->
      @if (existingImages.length > 0) {
        <div class="existing-images">
          <p class="section-title">Images actuelles :</p>
          <div class="image-previews">
            @for (image of existingImages; track image.id; let i = $index) {
              <div class="preview-item">
                <img [src]="image.url" [alt]="'Vue enregistrée ' + (i + 1)">
                <button 
                  type="button"
                  mat-icon-button 
                  color="warn"
                  class="remove-btn"
                  (click)="removeExistingImage(image.id, i)"
                  [disabled]="loading">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        </div>
      }
      
      <input 
        id="product-images-input"
        type="file" 
        #fileInput
        (change)="onFileSelected($event)"
        accept="image/*"
        multiple
        style="display: none">
      
      <button 
        type="button"
        mat-stroked-button 
        color="primary"
        (click)="fileInput.click()"
        [disabled]="loading">
        <mat-icon>add_photo_alternate</mat-icon>
        Ajouter des images
      </button>

      <!-- New Image Previews -->
      @if (imagePreviews.length > 0) {
        <div class="new-images">
          <p class="section-title">Nouvelles images :</p>
          <div class="image-previews">
            @for (preview of imagePreviews; track preview; let i = $index) {
              <div class="preview-item">
                <img [src]="preview" [alt]="'Prévisualisation ' + (i + 1)">
                <button 
                  type="button"
                  mat-icon-button 
                  color="warn"
                  class="remove-btn"
                  (click)="removeImage(i)"
                  [disabled]="loading">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        </div>
      }

      <p class="hint">Max 2MB par image. Formats acceptés: JPG, PNG, GIF</p>
    </div>

    <!-- Error Message -->
    @if (errorMessage) {
      <div class="error-message">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
      </div>
    }

    <!-- Upload Progress -->
    @if (loading && totalImages > 0) {
      <div class="upload-progress">
        <p>Upload des images: {{ uploadProgress }} / {{ totalImages }}</p>
        <mat-spinner diameter="30"></mat-spinner>
      </div>
    }
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="loading">
    Annuler
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()"
    [disabled]="productForm.invalid || loading">
    @if (loading && totalImages === 0) {
      <mat-spinner diameter="20"></mat-spinner>
    } @else {
      {{ data.mode === 'edit' ? 'Enregistrer' : 'Créer' }}
    }
  </button>
</mat-dialog-actions>
